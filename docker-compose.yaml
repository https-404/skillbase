services:
  # 1. SQL Database (PostgreSQL) - For Auth, Courses, Reviews
  db-sql:
    image: postgres:latest
    container_name: skillbase-sql
    restart: always
    environment:
      POSTGRES_USER: skillbaseadmin
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: skillbase_db
    ports:
      - '5432:5432' # Expose to host for dev tools (e.g., PgAdmin)
    volumes:
      - postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U skillbaseadmin"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 1a. PostgreSQL Initialization - Creates logical databases
  postgres-init:
    image: postgres:latest
    container_name: skillbase-postgres-init
    depends_on:
      db-sql:
        condition: service_healthy
    environment:
      PGHOST: db-sql
      PGPORT: 5432
      PGUSER: skillbaseadmin
      PGPASSWORD: password123
    entrypoint: >
      sh -c "
      sleep 2 &&
      psql -c 'CREATE DATABASE identity_db;' || true &&
      psql -c 'CREATE DATABASE course_db;' || true &&
      psql -c 'CREATE DATABASE reviews_db;' || true &&
      echo 'PostgreSQL databases initialized'
      "

  # 2. NoSQL Database (MongoDB) - For Learning Progress, Media Metadata
  db-nosql:
    image: mongo:latest
    container_name: skillbase-nosql
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: skillbaseadmin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: skillbase_db
    ports:
      - '27017:27017' # Expose to host for dev tools
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2a. MongoDB Initialization - Creates logical databases
  mongo-init:
    image: mongo:latest
    container_name: skillbase-mongo-init
    depends_on:
      db-nosql:
        condition: service_healthy
    environment:
      MONGO_INITDB_ROOT_USERNAME: skillbaseadmin
      MONGO_INITDB_ROOT_PASSWORD: password123
    entrypoint: >
      sh -c "
      sleep 3 &&
      mongosh mongodb://skillbaseadmin:password123@db-nosql:27017/admin --eval 'db.getSiblingDB(\"media_db\").createCollection(\"init\"); db.getSiblingDB(\"media_db\").init.drop();' &&
      mongosh mongodb://skillbaseadmin:password123@db-nosql:27017/admin --eval 'db.getSiblingDB(\"progress_db\").createCollection(\"init\"); db.getSiblingDB(\"progress_db\").init.drop();' &&
      echo 'MongoDB databases initialized'
      "

  # 3. Message Broker (RabbitMQ) - For Asynchronous Events
  # Exchange 'skillbase.events' (topic) will be created by services on startup
  # Standardized events: course.published, lesson.completed, review.created
  message-broker:
    image: rabbitmq:3-management
    container_name: skillbase-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: skillbaseadmin
      RABBITMQ_DEFAULT_PASS: password123
    ports:
      - '5672:5672' # AMQP protocol port (for services to connect)
      - '15672:15672' # Management UI port (check queues/messages at http://localhost:15672)

  # 4. Caching Service (Redis)
  caching-service:
    image: redis:latest
    container_name: skillbase-redis
    restart: always
    ports:
      - '6379:6379'

  # 5. Search Engine (Meilisearch)
  search-engine:
    image: getmeili/meilisearch:latest
    container_name: skillbase-meilisearch
    restart: always
    environment:
      MEILI_MASTER_KEY: masterKey
    ports:
      - '7700:7700' # Expose for Indexer Service and API Gateway

  # 6. Object Storage (MinIO) - For Media Files (Videos, Documents)
  minio:
    image: minio/minio:latest
    container_name: skillbase-minio
    restart: always
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    ports:
      - '9000:9000' # S3 API
      - '9001:9001' # Web UI
    volumes:
      - minio_data:/data

  # 7. MinIO Initialization - Creates bucket and sets permissions
  minio-init:
    image: minio/mc:latest
    container_name: skillbase-minio-init
    depends_on:
      - minio
    entrypoint: >
      sh -c "
      sleep 5 &&
      mc alias set local http://minio:9000 minioadmin minioadmin123 &&
      mc mb -p local/skillbase-media || true &&
      mc anonymous set public local/skillbase-media
      "

volumes:
  postgres_data:
  mongo_data:
  minio_data:
